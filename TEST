import React, { useState, useEffect, useMemo } from 'react';
import { Calculator, DollarSign, PieChart, Plus, Trash2, Wallet, ArrowDownCircle, ArrowUpCircle, HelpCircle, FileText, X, ChevronDown } from 'lucide-react';

const App = () => {
  // --- 常數設定：層次職加對照表 ---
  // 已更新為您提供的完整數據
  const LEVEL_OPTIONS = useMemo(() => [
    { code: '19', value: 51795 },
    { code: '18', value: 44735 },
    { code: '17', value: 39435 },
    { code: '16', value: 35905 },
    { code: '15', value: 32370 },
    { code: '14', value: 28840 },
    { code: '13', value: 25310 },
    { code: '12', value: 21780 },
    { code: '11', value: 19135 },
    { code: '10', value: 16480 },
    { code: '09', value: 13835 },
    { code: '08', value: 11190 },
    { code: '07', value: 9420 },
    { code: '06', value: 8245 },
    { code: '05', value: 7070 },
    { code: '04', value: 5890 },
    { code: '03', value: 4715 },
    { code: '02', value: 3535 },
    { code: '01', value: 2360 },
    { code: '00', value: 0 },
  ], []);

  // --- 狀態管理 ---

  // 1. 月薪收入項目
  const [incomeItems, setIncomeItems] = useState({
    base: 0,       // 薪額
    level: 0,       // 層次職加 (預設對應 00)
    meal: 0,        // 伙食津貼
    transport: 0,   // 交通津貼
    attendance: 0,  // 全勤獎金 (月)
  });

  // 層次職加的選單狀態 (預設 '00')
  const [selectedLevelCode, setSelectedLevelCode] = useState('00');

  // 2. 月扣款項目
  const [deductionItems, setDeductionItems] = useState({
    unionFee: 0,     // 工會會費
    unionMutual: 0,   // 工會傷亡互助金
    labor: 0,        // 勞保費
    welfare: 0,      // 職工福利金
    health: 0,       // 全民健保費
    stockTrust: 0,   // 持股信託提存金
  });

  // 3. 年度獎金項目
  const [bonuses, setBonuses] = useState([
    { id: 1, name: '春節獎金', type: 'month', value: 0 },
    { id: 2, name: '端午節獎金', type: 'month', value: 0 },
    { id: 3, name: '中秋節獎金', type: 'month', value: 0 },
    { id: 5, name: '績效獎金', type: 'month', value: 0 },
    { id: 6, name: '企業化特別獎金', type: 'fixed', value: 0 },
    { id: 7, name: '員工酬勞', type: 'fixed', value: 0 },
  ]);

  const [showDetails, setShowDetails] = useState(false);

  // --- 計算結果狀態 ---
  const [results, setResults] = useState({
    monthlyGross: 0,
    monthlyDeduction: 0,
    monthlyNet: 0,
    bonusBase: 0,
    totalBonus: 0,
    annualGross: 0,
    annualNet: 0,
  });

  // --- 處理層次職加變更 ---
  
  // 當選單改變時
  const handleLevelSelectChange = (e) => {
    const code = e.target.value;
    setSelectedLevelCode(code);
    
    if (code !== 'custom') {
      const option = LEVEL_OPTIONS.find(opt => opt.code === code);
      if (option) {
        setIncomeItems(prev => ({ ...prev, level: option.value }));
      }
    }
  };

  // 當手動輸入金額時
  const handleLevelAmountChange = (value) => {
    const numValue = Number(value);
    setIncomeItems(prev => ({ ...prev, level: numValue }));
    
    // 檢查輸入的值是否剛好對應某個選項，如果是則選中該選項，否則切換為自定義
    const matchedOption = LEVEL_OPTIONS.find(opt => opt.value === numValue);
    if (matchedOption) {
      setSelectedLevelCode(matchedOption.code);
    } else {
      setSelectedLevelCode('custom');
    }
  };

  // --- 計算邏輯 ---
  useEffect(() => {
    // 1. 計算月薪總額
    const monthlyGross = Object.values(incomeItems).reduce((a, b) => a + Number(b), 0);
    
    // 2. 計算月扣款總額
    const monthlyDeduction = Object.values(deductionItems).reduce((a, b) => a + Number(b), 0);
    
    // 3. 計算實領月薪
    const monthlyNet = monthlyGross - monthlyDeduction;

    // 4. 計算獎金基底 (薪額 + 層次職加)
    const bonusBase = Number(incomeItems.base) + Number(incomeItems.level);

    // 5. 計算年度獎金總額
    const totalBonus = bonuses.reduce((sum, item) => {
      if (item.type === 'month') {
        return sum + (item.value * bonusBase);
      } else {
        return sum + Number(item.value);
      }
    }, 0);

    // 6. 計算年薪
    const annualGross = (monthlyGross * 12) + totalBonus;
    const annualNet = (monthlyNet * 12) + totalBonus; 

    setResults({
      monthlyGross,
      monthlyDeduction,
      monthlyNet,
      bonusBase,
      totalBonus,
      annualGross,
      annualNet
    });

  }, [incomeItems, deductionItems, bonuses]);

  // --- 輔助函式 ---
  const formatCurrency = (num) => {
    return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(num);
  };

  const handleIncomeChange = (field, value) => {
    setIncomeItems(prev => ({ ...prev, [field]: Number(value) }));
  };

  const handleDeductionChange = (field, value) => {
    setDeductionItems(prev => ({ ...prev, [field]: Number(value) }));
  };

  const handleBonusChange = (id, field, value) => {
    setBonuses(bonuses.map(b => b.id === id ? { ...b, [field]: value } : b));
  };

  const addBonus = () => {
    const newId = Math.max(...bonuses.map(b => b.id), 0) + 1;
    setBonuses([...bonuses, { id: newId, name: '新增獎金', type: 'fixed', value: 0 }]);
  };

  const removeBonus = (id) => {
    setBonuses(bonuses.filter(b => b.id !== id));
  };

  return (
    <div className="min-h-screen bg-slate-50 p-2 md:p-6 font-sans text-slate-800">
      <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        {/* 左側：詳細設定 (佔 7 欄) */}
        <div className="lg:col-span-7 space-y-6">
          
          {/* 1. 月薪收入設定 */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div className="bg-blue-600 px-6 py-4 flex justify-between items-center">
              <h2 className="text-white font-bold flex items-center gap-2">
                <ArrowUpCircle className="w-5 h-5" /> 每月薪津項目 (收入)
              </h2>
              <span className="text-blue-100 text-sm">小計: {formatCurrency(results.monthlyGross)}</span>
            </div>
            <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
              <InputGroup label="1. 薪額 (獎金基底)" value={incomeItems.base} onChange={(v) => handleIncomeChange('base', v)} highlight />
              
              {/* 特別處理：層次職加 (包含選單與輸入框) */}
              <div className="md:col-span-1">
                <label className="block text-xs font-medium mb-1 text-blue-600">
                  2. 層次職加
                </label>
                <div className="flex gap-2">
                  <div className="relative w-1/3">
                    <select
                      value={selectedLevelCode}
                      onChange={handleLevelSelectChange}
                      className="w-full h-full p-2 pl-2 text-sm bg-blue-50 border border-blue-300 rounded outline-none focus:ring-2 focus:ring-blue-200 appearance-none font-mono"
                    >
                      <option value="custom">自訂</option>
                      {LEVEL_OPTIONS.map(opt => (
                        <option key={opt.code} value={opt.code}>
                          {opt.code}
                        </option>
                      ))}
                    </select>
                    <ChevronDown className="absolute right-2 top-3 w-3 h-3 text-blue-400 pointer-events-none" />
                  </div>
                  <div className="relative flex-1">
                      <input 
                      type="number" 
                      value={incomeItems.level} 
                      onChange={(e) => handleLevelAmountChange(e.target.value)}
                      className="w-full p-2 pl-3 text-right border border-blue-300 bg-blue-50 rounded outline-none transition font-mono focus:ring-2 focus:ring-blue-200"
                    />
                  </div>
                </div>
              </div>

              <InputGroup label="3. 伙食津貼" value={incomeItems.meal} onChange={(v) => handleIncomeChange('meal', v)} />
              <InputGroup label="4. 交通津貼" value={incomeItems.transport} onChange={(v) => handleIncomeChange('transport', v)} />
              <InputGroup label="5. 全勤獎金 (月)" value={incomeItems.attendance} onChange={(v) => handleIncomeChange('attendance', v)} />
            </div>
            <div className="bg-blue-50 px-6 py-2 text-xs text-blue-800 flex items-center gap-2">
              <HelpCircle className="w-4 h-4" />
              <span>說明：已將年度全勤獎金(0.4個月)視為包含在每月的「全勤獎金」中，故不在此重複計算年度獎金。</span>
            </div>
          </div>

          {/* 2. 月扣款設定 */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
             <div className="bg-slate-700 px-6 py-4 flex justify-between items-center">
              <h2 className="text-white font-bold flex items-center gap-2">
                <ArrowDownCircle className="w-5 h-5 text-red-400" /> 每月扣款／提存
              </h2>
               <span className="text-slate-300 text-sm">小計: -{formatCurrency(results.monthlyDeduction)}</span>
            </div>
            <div className="p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
              <InputGroup label="1. 工會會費" value={deductionItems.unionFee} onChange={(v) => handleDeductionChange('unionFee', v)} />
              <InputGroup label="2. 傷亡互助金" value={deductionItems.unionMutual} onChange={(v) => handleDeductionChange('unionMutual', v)} />
              <InputGroup label="3. 勞保費" value={deductionItems.labor} onChange={(v) => handleDeductionChange('labor', v)} />
              <InputGroup label="4. 職工福利金" value={deductionItems.welfare} onChange={(v) => handleDeductionChange('welfare', v)} />
              <InputGroup label="5. 全民健保費" value={deductionItems.health} onChange={(v) => handleDeductionChange('health', v)} />
              <InputGroup label="6. 持股信託提存金" value={deductionItems.stockTrust} onChange={(v) => handleDeductionChange('stockTrust', v)} />
            </div>
          </div>

          {/* 3. 年度獎金設定 */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div className="bg-emerald-600 px-6 py-4 flex justify-between items-center">
              <h2 className="text-white font-bold flex items-center gap-2">
                <Wallet className="w-5 h-5" /> 年度獎金與分紅
              </h2>
              <button onClick={addBonus} className="text-xs bg-emerald-700 hover:bg-emerald-800 text-white px-3 py-1 rounded-full transition flex items-center gap-1">
                <Plus className="w-3 h-3" /> 新增
              </button>
            </div>
            <div className="p-4 space-y-2">
              <div className="grid grid-cols-12 gap-2 text-xs text-slate-500 px-2 mb-1">
                <div className="col-span-4">項目名稱</div>
                <div className="col-span-3">類型</div>
                <div className="col-span-3">數值</div>
                <div className="col-span-2 text-right">預估金額</div>
              </div>
              {bonuses.map((bonus) => (
                <div key={bonus.id} className="grid grid-cols-12 gap-2 items-center bg-slate-50 p-2 rounded hover:bg-slate-100 transition">
                  <div className="col-span-4">
                    <input 
                      type="text" 
                      value={bonus.name}
                      onChange={(e) => handleBonusChange(bonus.id, 'name', e.target.value)}
                      className="w-full bg-transparent border-b border-transparent focus:border-emerald-500 outline-none text-sm font-medium"
                    />
                  </div>
                  <div className="col-span-3">
                    <select 
                      value={bonus.type}
                      onChange={(e) => handleBonusChange(bonus.id, 'type', e.target.value)}
                      className="w-full text-xs p-1 bg-white border border-slate-300 rounded"
                    >
                      <option value="month">個月 (Base)</option>
                      <option value="fixed">固定金額</option>
                    </select>
                  </div>
                  <div className="col-span-3 relative">
                    <input 
                      type="number" 
                      value={bonus.value}
                      onChange={(e) => handleBonusChange(bonus.id, 'value', Number(e.target.value))}
                      step={bonus.type === 'month' ? 0.1 : 1000}
                      className="w-full p-1 text-right text-sm bg-white border border-slate-300 rounded outline-none focus:border-emerald-500"
                    />
                      <span className="absolute right-8 top-1.5 text-xs text-slate-400 pointer-events-none">
                        {bonus.type === 'month' ? '月' : ''}
                      </span>
                  </div>
                  <div className="col-span-2 flex justify-end items-center gap-2">
                    <span className="text-sm font-mono text-emerald-700">
                      {bonus.type === 'month' 
                        ? (bonus.value * results.bonusBase / 10000).toFixed(1) + '萬'
                        : (bonus.value / 10000).toFixed(1) + '萬'
                      }
                    </span>
                    <button onClick={() => removeBonus(bonus.id)} className="text-slate-400 hover:text-red-500"><Trash2 className="w-3 h-3"/></button>
                  </div>
                </div>
              ))}
            </div>
            <div className="bg-emerald-50 px-6 py-2 text-right text-sm font-bold text-emerald-800">
              獎金總計: {formatCurrency(results.totalBonus)}
            </div>
          </div>

        </div>

        {/* 右側：儀表板 (佔 5 欄) */}
        <div className="lg:col-span-5 space-y-6">
          
          {/* 總結卡片 */}
          <div className="bg-slate-800 text-white rounded-2xl shadow-xl p-6 md:p-8 flex flex-col items-center justify-center text-center relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-emerald-400 to-blue-500"></div>
            
            <h3 className="text-slate-400 text-sm font-medium uppercase tracking-wider mb-2">預估稅前總年薪</h3>
            <div className="text-4xl md:text-5xl font-bold text-white mb-2 font-mono tracking-tight">
              {formatCurrency(results.annualGross)}
            </div>
            <div className="text-slate-400 text-sm mb-6">
              (月實領約 {formatCurrency(results.monthlyNet)})
            </div>

            <div className="w-full grid grid-cols-2 gap-4 border-t border-slate-700 pt-6">
              <div className="text-left">
                <div className="text-xs text-slate-400 mb-1">固定薪資 (12個月)</div>
                <div className="text-lg font-semibold text-blue-300">{formatCurrency(results.monthlyGross * 12)}</div>
              </div>
              <div className="text-right">
                <div className="text-xs text-slate-400 mb-1">變動獎金與分紅</div>
                <div className="text-lg font-semibold text-emerald-300">{formatCurrency(results.totalBonus)}</div>
              </div>
            </div>

             <button 
              onClick={() => setShowDetails(!showDetails)}
              className="mt-6 w-full py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm text-slate-300 flex items-center justify-center gap-2 transition"
            >
              <FileText className="w-4 h-4" />
              {showDetails ? '隱藏計算明細' : '查看計算過程明細'}
            </button>
          </div>

          {/* 計算細節 Modal/Panel */}
          {showDetails && (
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-in fade-in zoom-in-95 duration-200">
              <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">
                  <Calculator className="w-5 h-5 text-blue-500" /> 計算過程明細
                </h3>
                <button onClick={() => setShowDetails(false)} className="text-slate-400 hover:text-slate-600"><X className="w-4 h-4"/></button>
              </div>
              
              <div className="space-y-4 text-sm font-mono text-slate-600">
                {/* 1. 月薪部分 */}
                <div>
                  <div className="font-bold text-slate-800 mb-1">A. 固定月薪總和 (×12)</div>
                  <div className="pl-4 border-l-2 border-blue-200 space-y-1">
                    <div className="flex justify-between">
                      <span>( {incomeItems.base} + {incomeItems.level} + {incomeItems.meal} + {incomeItems.transport} + {incomeItems.attendance} ) × 12</span>
                    </div>
                    <div className="flex justify-between text-blue-600 font-bold">
                      <span>= {formatCurrency(results.monthlyGross * 12)}</span>
                    </div>
                  </div>
                </div>

                {/* 2. 獎金部分 */}
                <div>
                  <div className="font-bold text-slate-800 mb-1">B. 獎金計算基底 (Base)</div>
                    <div className="pl-4 border-l-2 border-emerald-200 mb-2 text-xs text-slate-500">
                      <span>薪額 {incomeItems.base} + 層次職加 {incomeItems.level} = </span>
                      <span className="font-bold text-emerald-600">{formatCurrency(results.bonusBase)}</span>
                    </div>

                  <div className="font-bold text-slate-800 mb-1">C. 各項獎金明細</div>
                  <div className="pl-4 border-l-2 border-emerald-200 space-y-1">
                    {bonuses.map(b => (
                      <div key={b.id} className="flex justify-between">
                        <span>
                          {b.name} 
                          {b.type === 'month' ? ` (${b.value}個月)` : ''}
                        </span>
                        <span>
                          {b.type === 'month' 
                            ? `${formatCurrency(results.bonusBase)} × ${b.value} = ${formatCurrency(b.value * results.bonusBase)}`
                            : formatCurrency(b.value)
                          }
                        </span>
                      </div>
                    ))}
                    <div className="flex justify-between text-emerald-600 font-bold border-t border-slate-100 pt-1 mt-1">
                      <span>獎金小計</span>
                      <span>= {formatCurrency(results.totalBonus)}</span>
                    </div>
                  </div>
                </div>

                {/* 3. 總計 */}
                <div className="pt-2 border-t border-slate-200 mt-2">
                  <div className="flex justify-between font-bold text-base text-slate-900">
                    <span>總年薪 (A + C)</span>
                    <span>{formatCurrency(results.annualGross)}</span>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* 結構分析 (隱藏細節時顯示) */}
          {!showDetails && (
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <PieChart className="w-5 h-5" /> 薪資結構分析
              </h3>
              
              <div className="space-y-4">
                <BarItem 
                  label="底薪結構 (薪額+職加)" 
                  value={results.bonusBase * 12} 
                  total={results.annualGross} 
                  color="bg-blue-500" 
                />
                <BarItem 
                  label="月津貼 (伙食+交通+全勤)" 
                  value={(results.monthlyGross - results.bonusBase) * 12} 
                  total={results.annualGross} 
                  color="bg-blue-300" 
                />
                <BarItem 
                  label="年節與績效獎金" 
                  value={results.totalBonus} 
                  total={results.annualGross} 
                  color="bg-emerald-500" 
                />
              </div>
              
              <div className="mt-6 pt-6 border-t border-slate-100">
                <h4 className="text-sm font-semibold text-slate-600 mb-2">快速摘要</h4>
                <ul className="text-sm space-y-2 text-slate-500">
                  <li className="flex justify-between">
                    <span>月薪總額:</span>
                    <span className="font-mono text-slate-800">{formatCurrency(results.monthlyGross)}</span>
                  </li>
                  <li className="flex justify-between text-red-400">
                    <span>每月扣款:</span>
                    <span className="font-mono">- {formatCurrency(results.monthlyDeduction)}</span>
                  </li>
                  <li className="flex justify-between border-t border-slate-100 pt-2 font-bold">
                    <span>每月實領:</span>
                    <span className="font-mono text-slate-800">{formatCurrency(results.monthlyNet)}</span>
                  </li>
                </ul>
              </div>
            </div>
          )}

        </div>
      </div>
    </div>
  );
};

// 小元件：輸入框組合
const InputGroup = ({ label, value, onChange, highlight = false }) => (
  <div>
    <label className={`block text-xs font-medium mb-1 ${highlight ? 'text-blue-600' : 'text-slate-500'}`}>
      {label}
    </label>
    <div className="relative">
      <input 
        type="number" 
        value={value} 
        onChange={(e) => onChange(e.target.value)}
        className={`w-full p-2 pl-3 text-right border rounded outline-none transition font-mono ${highlight ? 'border-blue-300 bg-blue-50 focus:ring-2 focus:ring-blue-200' : 'border-slate-200 bg-white focus:border-slate-400'}`}
      />
    </div>
  </div>
);

// 小元件：條狀圖
const BarItem = ({ label, value, total, color }) => (
  <div>
    <div className="flex justify-between text-xs mb-1 text-slate-500">
      <span>{label}</span>
      <span>{Math.round((value / total) * 100)}%</span>
    </div>
    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
      <div 
        className={`${color} h-full rounded-full transition-all duration-500`} 
        style={{ width: `${(value / total) * 100}%` }}
      ></div>
    </div>
  </div>
);

export default App;
